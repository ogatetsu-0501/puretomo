<!DOCTYPE html> <!-- HTML文書の種類を宣言するよ -->
<html lang="ja"> <!-- 日本語のページであることを指定するよ -->
  <head>
    <!-- ページの基本設定 -->
    <meta charset="UTF-8" /> <!-- 文字コードをUTF-8にするよ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!-- 画面サイズに合わせるよ -->
    <title>アバター管理画面</title> <!-- ページタイトルを設定するよ -->
    <style>
      /* ----- 全体の基本設定 ----- */
      html, body {
        height: 100%;       /* 画面の高さを100%にするよ */
        margin: 0;          /* 余白をなくすよ */
        padding: 0;         /* 内側の余白もなくすよ */
      }
      body {
        font-family: Arial, sans-serif;  /* フォントをArialに設定するよ */
      }
      
      /* ----- ヘッダー ----- */
      header {
        display: flex;        /* ヘッダー内の要素を横並びにするよ */
        align-items: center;  /* 垂直方向に中央揃えするよ */
        background-color: #4caf50;  /* 背景を緑にするよ */
        color: white;         /* 文字色を白にするよ */
        padding: 10px;        /* ヘッダー内に余白を作るよ */
      }
      .hamburger {
        font-size: 24px;      /* ハンバーガーアイコンを大きくするよ */
        cursor: pointer;      /* カーソルがポインターになるよ */
        margin-right: 10px;   /* アイコンの右に余白を作るよ */
      }
      
      /* ----- サイドバー（サイドメニュー） ----- */
      .sidebar {
        position: fixed;      /* 画面に固定するよ */
        top: 0;               /* 上端にくっつけるよ */
        left: -220px;         /* 初めは画面外（左）に隠すよ */
        width: 200px;         /* サイドバーの幅を200pxにするよ */
        height: 100vh;        /* 画面全体の高さにするよ */
        background-color: #333;  /* 背景色を濃いグレーにするよ */
        color: white;         /* 文字色を白にするよ */
        transition: left 0.3s ease; /* サイドバーの出し入れをなめらかにするよ */
        z-index: 1500;        /* 他の要素より前に表示するよ */
      }
      
      /* ----- メインエリア（全画面切替用コンテナ） ----- */
      .main-container {
        position: relative;   /* 中の要素を相対配置するための基準にするよ */
        width: 100%;          /* 横いっぱいにするよ */
        height: calc(100vh - 50px);  /* ヘッダー分の高さを引くよ */
        overflow: hidden;     /* はみ出した部分を隠すよ */
        transition: margin-left 0.3s ease;  /* アニメーションで左右の余白を変えるよ */
      }
      
      /* ----- 左右パネル（全画面切替用） ----- */
      .left-panel, .right-panel {
        position: absolute;   /* 絶対配置するよ */
        top: 0;               /* 上端に配置するよ */
        width: 100%;          /* 横いっぱいにするよ */
        height: 100%;         /* 高さをコンテナに合わせるよ */
        transition: transform 0.3s ease; /* スライドアニメーションをするよ */
      }
      .left-panel { 
        transform: translateX(-100%); /* 左パネルは初めに画面外に隠すよ */
      }
      .right-panel {
        transform: translateX(0);  /* 右パネルは初めから表示するよ */
      }
      
      /* ----- 矢印ボタン（画面切替用） ----- */
      #switchToLeft {
        position: fixed;        /* 画面に固定するよ */
        top: 50%;               /* 垂直方向の中央に配置するよ */
        left: 0;                /* 左端に配置するよ */
        transform: translateY(-50%); /* 真ん中に持ってくるよ */
        z-index: 1600;          /* 他の要素より前に出すよ */
      }
      #switchToRight {
        position: fixed;        /* 画面に固定するよ */
        top: 50%;               /* 垂直方向の中央に配置するよ */
        right: 0;               /* 右端に配置するよ */
        transform: translateY(-50%); /* 真ん中に持ってくるよ */
        z-index: 1600;          /* 他の要素より前に出すよ */
        display: none;          /* 初めは非表示にするよ */
      }
      
      /* ----- テーブルの設定 ----- */
      th, td {
        border: 1px solid #ccc; /* セルに枠線をつけるよ */
        padding: 8px;           /* 内側に余白を作るよ */
        text-align: center;     /* 文字を中央にするよ */
        white-space: nowrap;    /* 1行で表示するよ */
      }
      thead th {
        position: sticky;       /* ヘッダー行を固定するよ */
        top: 0;                 /* 上端に固定するよ */
        background-color: #e0e0e0; /* ヘッダーの背景色 */
        z-index: 4;             /* ヘッダーを前面に出すよ */
      }
      tbody td:first-child, thead th:first-child {
        position: sticky;       /* 1列目を固定するよ */
        left: 0;                /* 左端に固定するよ */
        background-color: #f0f0f0; /* 背景色を設定するよ */
        z-index: 3;             /* ヘッダーの下に出すよ */
      }
      
      /* ----- スクロール可能なテーブルコンテナ ----- */
      .scrollable-table-container {
        overflow: auto; 
        position: relative;
        max-height: calc(100vh - 50px);  /* ウィンドウ高さからヘッダーの高さを引くよ */
        width: auto;
      }
      table {
        border-collapse: collapse; /* セルの境界線をまとめるよ */
        table-layout: auto;         /* セルの幅は中身に合わせるよ */
        width: auto;               /* 横幅は自動調整するよ */
        max-width: 100%;          /* 最大横幅は100%にするよ */
      }
      
      /* ----- 更新希望ステータス ----- */
      .update-status-group {
        display: flex;  /* 横並びにするよ */
        flex-wrap: wrap; /* 折り返すよ */
      }
      .update-status-group label {
        margin-right: 10px; /* 右に余白を作るよ */
      }
      
      /* ----- モーダルウィンドウ（詳細表示用） ----- */
      #modalWindow {
        display: none;         /* 初めは非表示にするよ */
        position: fixed;        /* 画面に固定するよ */
        top: 50%;               /* 垂直方向の中央にするよ */
        left: 50%;              /* 水平方向の中央にするよ */
        transform: translate(-50%, -50%); /* 完全に中央に持ってくるよ */
        width: 80%;             /* 横幅は80%にするよ */
        max-width: 600px;       /* 最大横幅は600pxにするよ */
        background-color: #fff; /* 背景は白にするよ */
        border: 1px solid #ccc; /* 枠線をつけるよ */
        padding: 15px;          /* 内側に余白を作るよ */
        z-index: 1000;          /* 前面に出すよ */
        box-shadow: 0 0 10px rgba(0,0,0,0.5); /* 影を付けるよ */
      }
      #modalContent {
        display: flex;           /* 横並びにするよ */
        flex-direction: row;     /* 横方向に並べるよ */
        overflow-x: auto;        /* 横方向にスクロール可能にするよ */
      }
      .modalItem {
        border: 1px solid #ddd;  /* 枠線をつけるよ */
        margin-right: 10px;      /* 右に余白を作るよ */
        padding: 5px;            /* 内側に余白を作るよ */
        text-align: center;      /* 文字を中央にするよ */
      }
      .modalItem img {
        max-width: 100px;        /* 画像の最大幅を100pxにするよ */
        display: block;          /* ブロック要素にするよ */
        margin: 0 auto 5px;      /* 画像を中央配置し下に余白を作るよ */
      }
      #closeModal {
        width: 100%;             /* ボタンを横いっぱいにするよ */
        margin-top: 15px;        /* 上に余白を作るよ */
        background-color: #4caf50; /* 背景を緑にするよ */
        color: #fff;             /* 文字色を白にするよ */
        border: none;            /* 枠線を消すよ */
        padding: 5px 10px;       /* 内側に余白を作るよ */
        cursor: pointer;         /* カーソルをポインターにするよ */
      }
    </style>
  </head>
  <body>
    <!-- ヘッダー部分 -->
    <header>
      <div class="hamburger" id="hamburgerBtn">&#9776;</div> <!-- ハンバーガーアイコン -->
      <h1 style="margin: 0; font-size: 18px">アバター管理</h1> <!-- ページタイトル -->
    </header>
    
    <!-- モーダルウィンドウ（詳細表示用） -->
    <div id="modalWindow">
      <div id="modalContent">
        <!-- ここに各 listingItem の詳細が横並びで表示されるよ -->
      </div>
      <button id="closeModal">閉じる</button> <!-- モーダルを閉じるボタン -->
    </div>
    
    <!-- 切替用の矢印ボタン -->
    <button id="switchToLeft">←</button> <!-- 右側表示中に左側へ切替えるボタン -->
    <button id="switchToRight" style="display: none;">→</button> <!-- 左側表示中に右側へ戻すボタン -->
    
    <!-- メインエリア（左右のパネルを収めるコンテナ） -->
    <div class="main-container" id="mainContainer">
      <!-- サイドバー（サイドメニュー） -->
      <div class="sidebar" id="sidebar">
        <ul>
          <li data-target="avatarForm">所持アバター追加</li> <!-- アバター追加画面へ切替 -->
          <li data-target="settings">設定</li>             <!-- 設定画面へ切替 -->
          <li data-target="tradeSearch">販売アバター検索</li> <!-- 販売検索画面へ切替 -->
        </ul>
      </div>
      <!-- 左側パネル（各種コンテンツ：フォーム、設定、販売検索） -->
      <div class="left-panel" id="leftPanel">
        <div id="avatarForm">
          <h2>所持アバター追加</h2>
          <div class="form-group">
            <label for="partInput">パーツ（表示名）:</label>
            <input type="text" id="partInput" list="partsList" autocomplete="on" placeholder="例: トップス" />
            <datalist id="partsList">
              <option value="トップス"></option>
              <option value="ボトムス"></option>
              <option value="ワンピース"></option>
              <option value="ヘアスタイル"></option>
              <option value="フェイス"></option>
              <option value="背景"></option>
              <option value="アウター"></option>
              <option value="セット衣装1"></option>
              <option value="セット衣装2"></option>
              <option value="帽子"></option>
              <option value="めがね"></option>
              <option value="アクセ1"></option>
              <option value="アクセ2"></option>
              <option value="雑貨1"></option>
              <option value="雑貨2"></option>
              <option value="ペット1"></option>
              <option value="ペット2"></option>
              <option value="ペット3"></option>
              <option value="ペット4"></option>
              <option value="エフェクト"></option>
              <option value="その他1"></option>
              <option value="その他2"></option>
              <option value="その他3"></option>
              <option value="その他4"></option>
              <option value="モイトイ"></option>
            </datalist>
          </div>
          <div class="form-group">
            <label for="type1Input">種類①:</label>
            <input type="text" id="type1Input" list="type1List" autocomplete="on" placeholder="例: INT" />
            <datalist id="type1List">
              <option value="INT"></option>
              <option value="ALL"></option>
              <option value="HPR"></option>
              <option value="SP"></option>
              <option value="PET"></option>
              <option value="HP"></option>
              <option value="SPR"></option>
              <option value="LUK"></option>
              <option value="ATK"></option>
              <option value="EXP"></option>
              <option value="MAT"></option>
              <option value="POW"></option>
              <option value="VIT"></option>
              <option value="SPD"></option>
            </datalist>
          </div>
          <div class="form-group">
            <label for="type2Input">種類②:</label>
            <input type="text" id="type2Input" list="type2List" autocomplete="on" placeholder="（未入力でも可）" disabled />
            <datalist id="type2List">
              <option value="INT"></option>
              <option value="ALL"></option>
              <option value="HPR"></option>
              <option value="SP"></option>
              <option value="PET"></option>
              <option value="HP"></option>
              <option value="SPR"></option>
              <option value="LUK"></option>
              <option value="ATK"></option>
              <option value="EXP"></option>
              <option value="MAT"></option>
              <option value="POW"></option>
              <option value="VIT"></option>
              <option value="SPD"></option>
            </datalist>
          </div>
          <div class="form-group">
            <label for="valueInput">上昇値:</label>
            <input type="number" id="valueInput" placeholder="数値を入力してください" />
          </div>
          <button id="addButton" disabled>追加</button>
        </div>
        
        <div id="settings" style="display: none">
          <h2>設定</h2>
          <div class="form-group">
            <label for="genderSelect">アバター性別選択:</label>
            <select id="genderSelect">
              <option value="F">女</option>
              <option value="M">男</option>
            </select>
          </div>
          <div class="form-group">
            <label>更新希望ステータス:</label>
            <div id="updateStatusContainer" class="update-status-group"></div>
          </div>
          <button id="saveSettingsButton">設定を保存</button>
        </div>
        
        <div id="tradeSearch" style="display: none">
          <h2>販売アバター検索</h2>
          <div id="tradeDataDisplay">
            <p>データ未読み込み</p>
          </div>
        </div>
      </div>
      
      <!-- 右側パネル（追加されたアバター一覧） -->
      <div class="right-panel" id="rightPanel">
        <h2>追加されたアバター一覧</h2>
        <div class="scrollable-table-container">
          <table id="avatarTable">
            <thead>
              <tr>
                <th>販売リンク</th>
                <th>パーツ</th>
                <th>種類①</th>
                <th>種類②</th>
                <th>上昇値</th>
                <th>削除</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <script>
      // --- 以下は画面切替やサイドバー、各フォームの処理 ---
      
      // 現在の全画面表示状態を管理する変数（"left":左側、"right":右側）
      let currentView = "right"; // 初期は右側表示
      
      // メインエリアコンテナを取得するよ
      const mainContainer = document.getElementById("mainContainer");
      // 左右パネルを取得するよ
      const leftPanel = document.getElementById("leftPanel");
      const rightPanel = document.getElementById("rightPanel");
      
      // 切替用の矢印ボタンを取得するよ
      const switchToLeftBtn = document.getElementById("switchToLeft");   // 右側表示中→左側表示へ
      const switchToRightBtn = document.getElementById("switchToRight"); // 左側表示中→右側表示へ
      
      // ページ読み込み時の初期設定をするよ
      window.addEventListener("load", function() {
        currentView = "right"; // 初めは右側表示
        leftPanel.style.transform = "translateX(-100%)"; // 左側パネルを隠すよ
        rightPanel.style.transform = "translateX(0)";     // 右側パネルを表示するよ
        mainContainer.style.marginLeft = "0";             // メインエリアの余白をリセットするよ
        switchToLeftBtn.style.display = "block";           // 左側へ切替えるボタンを表示するよ
        switchToRightBtn.style.display = "none";           // 右側へ戻すボタンは非表示にするよ
      });
      
      // 関数：左側コンテンツを表示するよ
      function switchToLeftView() {
        currentView = "left"; // 状態を左側表示にするよ
        leftPanel.style.transform = "translateX(0)";      // 左側パネルを表示するよ
        rightPanel.style.transform = "translateX(100%)";  // 右側パネルを右に移動して隠すよ
        switchToLeftBtn.style.display = "none";           // 左側切替ボタンを隠すよ
        switchToRightBtn.style.display = "block";         // 右側へ戻すボタンを表示するよ
      }
      
      // 関数：右側コンテンツ（追加されたアバター一覧）を表示するよ
      function switchToRightView() {
        currentView = "right"; // 状態を右側表示にするよ
        leftPanel.style.transform = "translateX(-100%)";  // 左側パネルを左に隠すよ
        rightPanel.style.transform = "translateX(0)";     // 右側パネルを表示するよ
        switchToLeftBtn.style.display = "block";          // 左側へ切替えるボタンを表示するよ
        switchToRightBtn.style.display = "none";          // 右側へ戻すボタンを隠すよ
      }
      
      // 矢印ボタンにクリックイベントを設定するよ
      switchToLeftBtn.addEventListener("click", switchToLeftView);
      switchToRightBtn.addEventListener("click", switchToRightView);
      
      // --- サイドバー（サイドメニュー）の処理 ---
      const hamburgerBtn = document.getElementById("hamburgerBtn"); // ハンバーガーアイコンを取得するよ
      const sidebar = document.getElementById("sidebar");           // サイドバーを取得するよ
      // ハンバーガーアイコンをクリックしたときの処理
      hamburgerBtn.addEventListener("click", function() {
        // もしサイドバーが隠れていたら
        if (sidebar.style.left === "" || sidebar.style.left === "-220px") {
          sidebar.style.left = "0";                // サイドバーを表示するよ
          mainContainer.style.marginLeft = "220px";  // メインエリアをサイドバー分右にずらすよ
          switchToLeftBtn.style.left = "220px";      // 切替ボタンもサイドバー分右にずらすよ
        } else {
          sidebar.style.left = "-220px";           // サイドバーを隠すよ
          mainContainer.style.marginLeft = "0";      // メインエリアの余白を戻すよ
          switchToLeftBtn.style.left = "0";          // 切替ボタンを元の位置に戻すよ
        }
      });
      
      // --- サイドバー項目選択による画面切替 ---
      const sidebarItems = document.querySelectorAll(".sidebar li");
      const avatarFormDiv = document.getElementById("avatarForm");
      const settingsDiv = document.getElementById("settings");
      const tradeSearchDiv = document.getElementById("tradeSearch");
      // 各サイドバー項目にクリックイベントを設定するよ
      sidebarItems.forEach(function(item) {
        item.addEventListener("click", function() {
          const target = item.getAttribute("data-target"); // クリックした項目のターゲットを取得するよ
          sidebar.style.left = "-220px";         // サイドバーを隠すよ
          mainContainer.style.marginLeft = "0";    // メインエリアの余白をリセットするよ
          switchToLeftBtn.style.left = "0";        // 切替ボタンの位置をリセットするよ
          if (target === "avatarForm") {           // 所持アバター追加画面の場合
            avatarFormDiv.style.display = "block";
            settingsDiv.style.display = "none";
            tradeSearchDiv.style.display = "none";
          } else if (target === "settings") {      // 設定画面の場合
            avatarFormDiv.style.display = "none";
            settingsDiv.style.display = "block";
            tradeSearchDiv.style.display = "none";
            const savedGender = localStorage.getItem("avatarGender"); // 保存された性別を取得するよ
            if (savedGender) {
              document.getElementById("genderSelect").value = savedGender; // 性別選択を反映するよ
            }
            generateUpdateStatusCheckboxes(); // 更新希望ステータスのチェックボックスを生成するよ
          } else if (target === "tradeSearch") {   // 販売アバター検索画面の場合
            avatarFormDiv.style.display = "none";
            settingsDiv.style.display = "none";
            tradeSearchDiv.style.display = "block";
            logItemCodes(); // 販売データを読み込むよ
          }
        });
      });
      
      // --- 所持アバター追加フォームの処理 ---
      // パーツ表示名と内部コードのマッピング（元々のbagcatのマッピングと同じ）
      const partsMapping = {
        "トップス": "H",
        "ボトムス": "L",
        "ワンピース": "HL",
        "ヘアスタイル": "P",
        "フェイス": "F",
        "背景": "A4",
        "アウター": "CT",
        "セット衣装1": "SA",
        "セット衣装2": "SB",
        "帽子": "AE",
        "めがね": "AD",
        "アクセ1": "AF",
        "アクセ2": "B2",
        "雑貨1": "B1",
        "雑貨2": "B3",
        "ペット1": "E1",
        "ペット2": "E2",
        "ペット3": "E3",
        "ペット4": "E4",
        "エフェクト": "AA",
        "その他1": "AB",
        "その他2": "A1",
        "その他3": "A2",
        "その他4": "A3",
        "モイトイ": "BL"
      };
      // 内部コードから表示名へのマッピング
      const bagcatLabels = {
        "H": "トップス",
        "L": "ボトムス",
        "HL": "ワンピース",
        "P": "ヘアスタイル",
        "F": "フェイス",
        "A4": "背景",
        "CT": "アウター",
        "SA": "セット衣装1",
        "SB": "セット衣装2",
        "AE": "帽子",
        "AD": "めがね",
        "AF": "アクセ1",
        "B2": "アクセ2",
        "B1": "雑貨1",
        "B3": "雑貨2",
        "E1": "ペット1",
        "E2": "ペット2",
        "E3": "ペット3",
        "E4": "ペット4",
        "AA": "エフェクト",
        "AB": "その他1",
        "A1": "その他2",
        "A2": "その他3",
        "A3": "その他4",
        "BL": "モイトイ"
      };
      // 種類の選択肢リスト
      const typeOptions = ["INT", "ALL", "HPR", "SP", "PET", "HP", "SPR", "LUK", "ATK", "EXP", "MAT", "POW", "VIT", "SPD"];
      // アバターリスト（所持アバターのデータを保持する配列）
      let avatarList = [];
      // ページ読み込み時にlocalStorageからアバターリストを取得するよ
      window.addEventListener("load", function() {
        const storedData = localStorage.getItem("avatarList");
        if (storedData) {
          avatarList = JSON.parse(storedData);
          renderAvatarTable(); // テーブルに表示するよ
        }
      });
      // 各フォームの要素を取得するよ
      const partInput = document.getElementById("partInput");
      const type1Input = document.getElementById("type1Input");
      const type2Input = document.getElementById("type2Input");
      const valueInput = document.getElementById("valueInput");
      const addButton = document.getElementById("addButton");
      const avatarTableBody = document.querySelector("#avatarTable tbody");
      
      // 種類①の入力変更時のイベント
      type1Input.addEventListener("change", function() {
        const selectedType1 = type1Input.value.trim();
        if (selectedType1 === "") {
          type2Input.disabled = true; // 種類①が空なら種類②を無効にするよ
          type2Input.value = "";
        } else {
          type2Input.disabled = false; // 種類①が入力されたら種類②を有効にするよ
          updateType2Datalist(selectedType1); // 種類②の候補を更新するよ
        }
        checkInput(); // 入力チェックをするよ
      });
      // 入力欄の入力イベントの設定
      partInput.addEventListener("input", checkInput);
      type1Input.addEventListener("input", checkInput);
      valueInput.addEventListener("input", checkInput);
      
      // 入力内容のチェックをする関数
      function checkInput() {
        const isPartEntered = partInput.value.trim() !== "";
        const isType1Entered = type1Input.value.trim() !== "";
        const isValueEntered = valueInput.value.trim() !== "" && !isNaN(valueInput.value);
        addButton.disabled = !(isPartEntered && isType1Entered && isValueEntered);
      }
      
      // 種類②の候補を更新する関数
      function updateType2Datalist(selectedType1) {
        const type2Datalist = document.getElementById("type2List");
        type2Datalist.innerHTML = "";
        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        type2Datalist.appendChild(emptyOption);
        typeOptions.forEach(function(option) {
          if (option !== selectedType1) {
            const opt = document.createElement("option");
            opt.value = option;
            type2Datalist.appendChild(opt);
          }
        });
      }
      
      // 追加ボタンをクリックしたときの処理
      addButton.addEventListener("click", function() {
        // 新しいアバターを作成するよ
        const newAvatar = {
          partText: partInput.value.trim(),  // パーツの表示名
          type1: type1Input.value.trim(),      // 種類①
          type2: (type2Input.value.trim() === "") ? "なし" : type2Input.value.trim(), // 種類②（未入力なら"なし"）
          increase: valueInput.value.trim()      // 上昇値
        };
        avatarList.push(newAvatar); // 配列に追加するよ
        renderAvatarTable();        // テーブルを更新するよ
        localStorage.setItem("avatarList", JSON.stringify(avatarList)); // 保存するよ
        // 入力欄をリセットするよ
        partInput.value = "";
        type1Input.value = "";
        type2Input.value = "";
        type2Input.disabled = true;
        valueInput.value = "";
        checkInput(); // 入力状況をチェックするよ
      });
      
      // アバター一覧テーブルを描画する関数
      function renderAvatarTable() {
        avatarTableBody.innerHTML = "";
        avatarList.forEach(function(avatar, index) {
          const row = document.createElement("tr"); // 行を作るよ
          const tdPart = document.createElement("td"); // セルを作るよ
          tdPart.textContent = avatar.partText; // パーツ名を設定するよ
          row.appendChild(tdPart); // 行に追加するよ
          const tdType1 = document.createElement("td");
          tdType1.textContent = avatar.type1;
          row.appendChild(tdType1);
          const tdType2 = document.createElement("td");
          tdType2.textContent = avatar.type2;
          row.appendChild(tdType2);
          const tdInc = document.createElement("td");
          tdInc.textContent = avatar.increase;
          row.appendChild(tdInc);
          const tdDel = document.createElement("td");
          const btnDel = document.createElement("button");
          btnDel.textContent = "削除"; // 削除ボタン
          btnDel.addEventListener("click", function() {
            avatarList.splice(index, 1); // 該当する要素を削除するよ
            renderAvatarTable();          // テーブルを更新するよ
            localStorage.setItem("avatarList", JSON.stringify(avatarList)); // 保存するよ
          });
          tdDel.appendChild(btnDel);
          row.appendChild(tdDel);
          avatarTableBody.appendChild(row);
        });
      }
      
      // --- 設定画面の処理 ---
      const saveSettingsButton = document.getElementById("saveSettingsButton");
      const genderSelect = document.getElementById("genderSelect");
      const updateStatusContainer = document.getElementById("updateStatusContainer");
      const updateStatusOptions = typeOptions; // 種類の選択肢をそのまま使うよ
      // 更新希望ステータスのチェックボックスを生成する関数
      function generateUpdateStatusCheckboxes() {
        updateStatusContainer.innerHTML = "";
        let savedStatus = localStorage.getItem("updateStatus");
        if (savedStatus) {
          savedStatus = JSON.parse(savedStatus);
        } else {
          savedStatus = [];
        }
        updateStatusOptions.forEach(function(status) {
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = "status_" + status;
          checkbox.value = status;
          if (savedStatus.includes(status)) {
            checkbox.checked = true; // 保存されたものはチェックするよ
          }
          const label = document.createElement("label");
          label.htmlFor = "status_" + status;
          label.textContent = status;
          updateStatusContainer.appendChild(checkbox);
          updateStatusContainer.appendChild(label);
        });
      }
      // 設定の保存ボタンをクリックしたときの処理
      saveSettingsButton.addEventListener("click", function() {
        localStorage.setItem("avatarGender", genderSelect.value); // 性別を保存するよ
        const checkboxes = updateStatusContainer.querySelectorAll('input[type="checkbox"]');
        const selectedStatuses = [];
        checkboxes.forEach(function(chk) {
          if (chk.checked) {
            selectedStatuses.push(chk.value); // チェックされているステータスを配列に入れるよ
          }
        });
        localStorage.setItem("updateStatus", JSON.stringify(selectedStatuses)); // 保存するよ
        alert("設定を保存しました。"); // 保存完了のアラート
      });
      
      // --- 販売アバター検索の処理 ---
      // uniqueTradeItems にはバザー（販売）データの一意のリストが入るよ
      let uniqueTradeItems = [];
      // 関数 logItemCodes() を改造して、bazzarList.json と itemCodeSchema.json、itemAnother.json を使うよ
      function logItemCodes() {
        // Promise.all() を使って3つのJSONファイルを同時に読み込むよ
        Promise.all([
          fetch("bazzarList.json") // bazzarList.json を取得
            .then(function(response) {
              // レスポンスをJSONに変換するよ
              return response.json();
            }),
          fetch("itemCodeSchema.json") // itemCodeSchema.json を取得
            .then(function(response) {
              return response.json();
            }),
          fetch("itemAnother.json") // itemAnother.json を取得
            .then(function(response) {
              return response.json();
            })
        ])
        .then(function([bazzarData, itemSchemaData, itemAnotherData]) {
          // 3つのJSONのデータが取れたよ
          
          // まず、bazzarList.json の中の "bazzarList" 配列を使うよ
          var seenBazaarIds = {}; // 重複チェック用のオブジェクトを作るよ
          uniqueTradeItems = [];  // 一意のバザーリストを入れる配列を初期化するよ
          bazzarData.bazzarList.forEach(function(item) {
            if (!seenBazaarIds[item.bazaarId]) { // もし同じ bazaarId がなければ
              uniqueTradeItems.push(item);     // 配列に追加するよ
              seenBazaarIds[item.bazaarId] = true; // 追加したことを記録するよ
            }
          });
          console.log("Step 0: バザーIDユニーク処理後", uniqueTradeItems);
          
          // itemCodeSchema.json と itemAnother.json を1つの配列にまとめるよ
          var combinedItems = [];
          if (Array.isArray(itemSchemaData)) {
            combinedItems = combinedItems.concat(itemSchemaData);
          }
          if (Array.isArray(itemAnotherData)) {
            combinedItems = combinedItems.concat(itemAnotherData);
          }
          
          // uniqueTradeItems の各アイテムについて処理するよ
          uniqueTradeItems.forEach(function(item) {
            if (Array.isArray(item.listingItems)) {
              // listingItems はもともとアイテムコードの文字列が入っているので
              // それをアイテム情報のオブジェクトに変換するよ
              item.listingItems = item.listingItems.map(function(itemCode) {
                // combinedItems から itemCode が一致するアイテムを探すよ
                var match = combinedItems.find(function(entry) {
                  return entry.itemCode === itemCode;
                });
                if (match) {
                  // 一致したら、必要な情報（itemName, parts, itemGender）をセットするよ
                  return {
                    itemCode: itemCode,         // アイテムコード
                    itemName: match.itemName,     // アイテム名
                    parts: match.parts,           // パーツ（以前のbagcatの代わり）
                    itemGender: match.itemGender  // アイテムの性別指定
                  };
                } else {
                  // 見つからなかった場合は空の情報を返すよ
                  return {
                    itemCode: itemCode,
                    itemName: "",
                    parts: "",
                    itemGender: ""
                  };
                }
              });
            }
          });
          console.log("Step 0-2: listingItems にアイテム情報を付加後", uniqueTradeItems);
          
          // itemName から種類とパラメーターを正規表現で抽出するよ
          var regex = /^【([^+]+)\+(\d+)％】/; // 例: "【EXP+2％】Ｅステッキ" の形式を想定するよ
          uniqueTradeItems.forEach(function(item) {
            if (Array.isArray(item.listingItems)) {
              item.listingItems.forEach(function(listItem) {
                var result = regex.exec(listItem.itemName); // 正規表現で抽出するよ
                if (result) {
                  listItem.type = result[1];               // 種類を設定するよ（例: EXP）
                  listItem.param = parseInt(result[2], 10);  // 数値部分をパラメーターとして設定するよ
                } else {
                  listItem.type = ""; // 抽出できなければ空文字にするよ
                  listItem.param = 0; // 数値は0にするよ
                }
              });
            }
          });
          console.log("Step 1: type, param 抽出後", uniqueTradeItems);
          
          // 各 listingItem について、所持アバターデータ（avatarList）と照合して差分 (diff) を計算するよ
          uniqueTradeItems.forEach(function(item) {
            if (Array.isArray(item.listingItems)) {
              item.listingItems.forEach(function(listItem) {
                // avatarList から、種類が同じかつ、パーツ（表示名から partsMapping で得られるコード）が一致するアバターを探すよ
                var matchingAvatar = avatarList.find(function(avatar) {
                  return (avatar.type1 === listItem.type) && (partsMapping[avatar.partText] === listItem.parts);
                });
                var diff = 0;
                if (matchingAvatar) {
                  // アバターがあれば、パラメーターから上昇値を引いた差分を計算するよ
                  diff = listItem.param - Number(matchingAvatar.increase);
                  if (diff < 0) diff = 0; // 差分が負なら0にするよ
                } else {
                  diff = listItem.param; // アバターがなければパラメーターがそのまま差分になるよ
                }
                listItem.diff = diff; // 差分を記録するよ
              });
            }
          });
          console.log("Step 2: diff 計算後", uniqueTradeItems);
          
          // 各バザー毎に、各種類の中で最大の差分（diff）を集計するよ
          uniqueTradeItems.forEach(function(item) {
            if (Array.isArray(item.listingItems) && item.listingItems.length > 0) {
              var uniqueDiffs = {}; // 種類毎の差分を保存するオブジェクト
              item.listingItems.forEach(function(listItem) {
                var key = listItem.type + "_" + listItem.parts; // キーは種類とパーツで作るよ
                if (uniqueDiffs[key] === undefined) {
                  uniqueDiffs[key] = listItem.diff; // 最初の差分を設定するよ
                } else {
                  // すでにある差分より大きければ更新するよ
                  if (listItem.diff > uniqueDiffs[key]) {
                    uniqueDiffs[key] = listItem.diff;
                  }
                }
              });
              // キーごとに集計し、item.typeSums に保存するよ
              item.typeSums = {};
              for (var key in uniqueDiffs) {
                if (uniqueDiffs.hasOwnProperty(key)) {
                  var t = key.split("_")[0]; // 種類部分を取り出すよ
                  if (!item.typeSums[t]) {
                    item.typeSums[t] = 0;
                  }
                  item.typeSums[t] += uniqueDiffs[key];
                }
              }
            }
          });
          console.log("Step 3: 各バザー毎の集計後", uniqueTradeItems);
          
          // 選択された性別でフィルタリングするよ（性別がFならMアイテムを除外、MならFを除外）
          var selectedGender = localStorage.getItem("avatarGender");
          var filteredTradeItems = uniqueTradeItems.filter(function(item) {
            if (!item.listingItems || !Array.isArray(item.listingItems)) return true;
            if (selectedGender === "F") {
              return !item.listingItems.some(function(listItem) { return listItem.itemGender === "M"; });
            } else if (selectedGender === "M") {
              return !item.listingItems.some(function(listItem) { return listItem.itemGender === "F"; });
            }
            return true;
          });
          console.log("Step 4: バザー性別フィルタリング後", filteredTradeItems);
          
          // 各バザーごとに、表示する種類（type）の一覧を作成するよ
          var allTypes = {};
          filteredTradeItems.forEach(function(item) {
            if (item.typeSums) {
              for (var t in item.typeSums) {
                if (item.typeSums.hasOwnProperty(t)) {
                  allTypes[t] = true;
                }
              }
            }
          });
          var selectedTypes = [];
          var savedUpdateStatus = localStorage.getItem("updateStatus");
          if (savedUpdateStatus) {
            selectedTypes = JSON.parse(savedUpdateStatus);
          }
          var displayTypes = Object.keys(allTypes).filter(function(t) { return selectedTypes.indexOf(t) !== -1; });
          displayTypes.sort(function(a, b) {
            var idxA = typeOptions.indexOf(a), idxB = typeOptions.indexOf(b);
            if (idxA === -1) idxA = typeOptions.length;
            if (idxB === -1) idxB = typeOptions.length;
            return idxA - idxB;
          });
          
          // HTMLの表を作成するよ
          var tableHTML = "<div class='scrollable-table-container'>";
          tableHTML += "<table style='border-collapse: collapse;'>";
          tableHTML += "<thead><tr>";
          tableHTML += "<th style='border: 1px solid #ccc; padding: 8px;'>販売リンク</th>";
          tableHTML += "<th style='border: 1px solid #ccc; padding: 8px;'>締め切り日時</th>";
          tableHTML += "<th style='border: 1px solid #ccc; padding: 8px;'>ハンコイン</th>";
          displayTypes.forEach(function(t) {
            tableHTML += "<th style='border: 1px solid #ccc; padding: 8px;'>" + t + "<br>(ハンコイン/差分)</th>";
          });
          tableHTML += "<th style='border: 1px solid #ccc; padding: 8px;'>詳細</th>";
          tableHTML += "</tr></thead>";
          tableHTML += "<tbody>";
          filteredTradeItems.forEach(function(item) {
            var sellEndDate = item.sellEndDate || "";
            if (sellEndDate.indexOf(" ") !== -1) {
              sellEndDate = sellEndDate.split(" ").join("<br>");
            }
            var hancoin = Number(item.hancoin) || 0;
            tableHTML += "<tr>";
            tableHTML += "<td style='border: 1px solid #ccc; padding: 8px;'><button onclick='openLinkInNewTab(\"" + item.bazaarId + "\")'>販売リンク</button></td>";
            tableHTML += "<td style='border: 1px solid #ccc; padding: 8px;'>" + sellEndDate + "</td>";
            tableHTML += "<td style='border: 1px solid #ccc; padding: 8px;'>" + hancoin + "</td>";
            displayTypes.forEach(function(t) {
              var sumDiff = (item.typeSums && item.typeSums[t]) ? item.typeSums[t] : 0;
              var ratio = sumDiff !== 0 ? (hancoin / sumDiff).toFixed(2) : "0";
              tableHTML += "<td style='border: 1px solid #ccc; padding: 8px;'>" + ratio + "</td>";
            });
            tableHTML += "<td style='border: 1px solid #ccc; padding: 8px;'><button onclick='showModal(\"" + item.bazaarId + "\")'>詳細</button></td>";
            tableHTML += "</tr>";
          });
          tableHTML += "</tbody></table>";
          tableHTML += "</div>";
          // 販売データ表示部分に作成したHTMLをセットするよ
          document.getElementById("tradeDataDisplay").innerHTML = tableHTML;
          console.log("Step 5: 表作成後");
          console.log(filteredTradeItems);
          
          // テーブルのヘッダーにソート用のクリックイベントを追加するよ
          var tradeTable = document.querySelector("#tradeDataDisplay .scrollable-table-container table");
          if (tradeTable) {
            var tradeHeaderCells = tradeTable.querySelectorAll("thead th");
            tradeHeaderCells.forEach(function(cell, index) {
              cell.addEventListener("click", function() {
                sortTableByColumn(tradeTable, index);
              });
            });
          }
        })
        .catch(function(error) {
          // エラーが発生したときはコンソールに出力するよ
          console.error("エラーが発生しました:", error);
        });
      }
      
      // 販売リンクボタンをクリックしたときに新しいタブでリンクを開く関数
      function openLinkInNewTab(bazaarId) {
        const url = "https://puretomo.hange.jp/bazaar/exhibitDetail/?info=LISTING_DETAIL&bazaarId=" + bazaarId;
        window.open(url, "_blank");
      }
      
      // --- モーダルウィンドウの処理 ---
      const modalWindow = document.getElementById("modalWindow"); // モーダルウィンドウ本体を取得するよ
      const modalContent = document.getElementById("modalContent"); // モーダル内のコンテンツ領域を取得するよ
      const closeModalBtn = document.getElementById("closeModal"); // モーダルを閉じるボタンを取得するよ
      closeModalBtn.addEventListener("click", function() {
        modalWindow.style.display = "none"; // モーダルを非表示にするよ
        modalContent.innerHTML = "";         // コンテンツを空にするよ
      });
      // モーダルに詳細情報を表示する関数
      function showModal(bazaarId) {
        var item = uniqueTradeItems.find(function(itm) {
          return itm.bazaarId === bazaarId;
        });
        if (!item) return; // 該当データがなければ何もしないよ
        modalContent.innerHTML = ""; // まずコンテンツをリセットするよ
        if (Array.isArray(item.listingItems)) {
          item.listingItems.forEach(function(listItem) {
            var itemDiv = document.createElement("div"); // 各アイテムの表示用DIVを作るよ
            itemDiv.className = "modalItem";             // クラスを設定するよ
            var img = document.createElement("img");       // 画像要素を作るよ
            img.src = "https://puretomo-image.hange.jp/disp/" + listItem.itemCode.toLowerCase() + ".gif"; // アイテム画像のURLを設定するよ
            itemDiv.appendChild(img);                      // DIVに画像を入れるよ
            // partsから表示するパーツ名を取得するよ（以前のbagcatLabelsと同じ） 
            var partsText = bagcatLabels[listItem.parts] || listItem.parts;
            var diffText = listItem.type + "+" + listItem.diff; // 種類と差分を文字列にまとめるよ
            var infoP = document.createElement("p");       // 情報表示用の段落を作るよ
            infoP.textContent = partsText + " / 差分: " + diffText; // テキストを設定するよ
            itemDiv.appendChild(infoP);                    // DIVに追加するよ
            var nameP = document.createElement("p");       // アイテム名用の段落を作るよ
            nameP.textContent = listItem.itemName;         // アイテム名を設定するよ
            itemDiv.appendChild(nameP);                    // DIVに追加するよ
            modalContent.appendChild(itemDiv);             // モーダルコンテンツにこのDIVを追加するよ
          });
        }
        modalWindow.style.display = "block"; // モーダルを表示するよ
      }
      
      // --- テーブルのヘッダークリック時のソート処理 ---
      function sortTableByColumn(table, colIndex) {
        var tbody = table.querySelector("tbody"); // tbody要素を取得するよ
        var rows = Array.from(tbody.querySelectorAll("tr")); // 全ての行を配列にするよ
        rows.sort(function(rowA, rowB) { // 行をソートするよ
          var cellA = rowA.children[colIndex]; // 比較するセルを取得するよ
          var cellB = rowB.children[colIndex];
          var numA = parseFloat(cellA.textContent); // 数値に変換するよ
          var numB = parseFloat(cellB.textContent);
          var sortA = (isNaN(numA) || numA === 0) ? Infinity : numA; // 数値でない場合はInfinityにするよ
          var sortB = (isNaN(numB) || numB === 0) ? Infinity : numB;
          return sortA - sortB; // 昇順にソートするよ
        });
        rows.forEach(function(row) { // ソート済みの行をtbodyに再配置するよ
          tbody.appendChild(row);
        });
      }
      
      // ページ読み込み時、アバター一覧テーブルのヘッダーセルにソートイベントを追加するよ
      var avatarTable = document.getElementById("avatarTable");
      if (avatarTable) {
        var avatarHeaderCells = avatarTable.querySelectorAll("thead th");
        avatarHeaderCells.forEach(function(cell, index) {
          cell.addEventListener("click", function() {
            sortTableByColumn(avatarTable, index);
          });
        });
      }
    </script>
  </body>
</html>
