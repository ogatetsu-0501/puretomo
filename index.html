<!DOCTYPE html>
<!-- HTML文書の種類を宣言するよ -->
<html lang="ja">
  <!-- 日本語のページだよ -->
  <head>
    <meta charset="UTF-8" />
    <!-- 文字コードはUTF-8にするよ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- 画面サイズに合わせるよ -->
    <title>アバター管理画面</title>
    <!-- ページタイトル -->
    <style>
      /* ----- 全体の基本設定 ----- */
      html,
      body {
        height: 100%; /* 画面全体の高さにするよ */
        margin: 0; /* 余白をなくすよ */
        padding: 0; /* 内側の余白もなくすよ */
      }
      body {
        font-family: Arial, sans-serif; /* フォントはArialにするよ */
      }

      /* ----- ヘッダー ----- */
      header {
        display: flex; /* 要素を横並びにするよ */
        align-items: center; /* 垂直方向に中央揃えするよ */
        background-color: #4caf50; /* 背景は緑にするよ */
        color: white; /* 文字色は白にするよ */
        padding: 10px; /* 内側に余白を作るよ */
      }
      .hamburger {
        font-size: 24px; /* アイコンを大きくするよ */
        cursor: pointer; /* カーソルをポインターにするよ */
        margin-right: 10px; /* 右に余白を作るよ */
      }

      /* ----- サイドバー（サイドメニュー） ----- */
      .sidebar {
        position: fixed; /* 画面に固定するよ */
        top: 0; /* 上端にくっつけるよ */
        left: -220px; /* 初めは画面外（左）に隠すよ */
        width: 200px; /* 幅は200pxにするよ */
        height: 100vh; /* 画面全体の高さにするよ */
        background-color: #333; /* 背景は濃いグレーにするよ */
        color: white; /* 文字色は白にするよ */
        transition: left 0.3s ease; /* なめらかに動かすよ */
        z-index: 1500; /* 前面に出すよ */
      }

      /* ----- メインエリア ----- */
      .main-container {
        position: relative; /* 内部要素の基準にするよ */
        width: 100%; /* 横いっぱいにするよ */
        height: calc(100vh - 50px); /* ヘッダー分を引いた高さにするよ */
        overflow: hidden; /* はみ出した部分は隠すよ */
        transition: margin-left 0.3s ease; /* 余白をなめらかに変えるよ */
      }

      /* ----- 左右パネル ----- */
      .left-panel,
      .right-panel {
        position: absolute; /* 絶対配置するよ */
        top: 0; /* 上端に配置するよ */
        width: 100%; /* 横いっぱいにするよ */
        height: 100%; /* 高さはコンテナに合わせるよ */
        transition: transform 0.3s ease; /* アニメーションをするよ */
      }
      .left-panel {
        transform: translateX(-100%); /* 初めは左側パネルを隠すよ */
      }
      .right-panel {
        transform: translateX(0); /* 右側パネルは表示するよ */
      }

      /* ----- 矢印ボタン ----- */
      #switchToLeft {
        position: fixed; /* 画面に固定するよ */
        top: 50%; /* 垂直方向の中央にするよ */
        left: 0; /* 左端にするよ */
        transform: translateY(-50%); /* 真ん中に持ってくるよ */
        z-index: 1600; /* 他の要素より前に出すよ */
      }
      #switchToRight {
        position: fixed; /* 画面に固定するよ */
        top: 50%; /* 垂直方向の中央にするよ */
        right: 0; /* 右端にするよ */
        transform: translateY(-50%); /* 真ん中に持ってくるよ */
        z-index: 1600; /* 他の要素より前に出すよ */
        display: none; /* 初めは非表示にするよ */
      }

      /* ----- テーブル設定 ----- */
      th,
      td {
        border: 1px solid #ccc; /* セルに枠線をつけるよ */
        padding: 8px; /* 内側に余白を作るよ */
        text-align: center; /* 文字を中央にするよ */
        white-space: nowrap; /* 1行で表示するよ */
      }
      thead th {
        position: sticky; /* ヘッダー行を固定するよ */
        top: 0; /* 上端にするよ */
        background-color: #e0e0e0; /* ヘッダーの背景色 */
        z-index: 4; /* 前面に出すよ */
      }
      tbody td:first-child,
      thead th:first-child {
        position: sticky; /* 1列目を固定するよ */
        left: 0; /* 左端にするよ */
        background-color: #f0f0f0; /* 背景色を設定するよ */
        z-index: 3; /* ヘッダーの下に出すよ */
      }

      /* ----- スクロール可能なテーブルコンテナ ----- */
      .scrollable-table-container {
        overflow: auto;
        position: relative;
        max-height: calc(100vh - 50px); /* ヘッダー分を引いた高さにするよ */
        width: auto;
      }
      table {
        border-collapse: collapse; /* セルの枠線をまとめるよ */
        table-layout: auto; /* セルの幅は内容に合わせるよ */
        width: auto; /* 横幅自動調整 */
        max-width: 100%; /* 最大横幅は100%にするよ */
      }

      /* ----- 更新希望ステータス ----- */
      .update-status-group {
        display: flex; /* 横並びにするよ */
        flex-wrap: wrap; /* 折り返すよ */
      }
      .update-status-group label {
        margin-right: 10px; /* 右に余白を作るよ */
      }

      /* ----- モーダルウィンドウ ----- */
      #modalWindow {
        display: none; /* 初めは非表示 */
        position: fixed; /* 画面に固定 */
        top: 50%; /* 垂直中央に */
        left: 50%; /* 水平中央に */
        transform: translate(-50%, -50%); /* 完全中央に */
        width: 80%; /* 横幅は80% */
        max-width: 600px; /* 最大横幅600px */
        background-color: #fff; /* 背景は白 */
        border: 1px solid #ccc; /* 枠線をつける */
        padding: 15px; /* 内側に余白 */
        z-index: 1000; /* 前面に出す */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* 影を付ける */
      }
      #modalContent {
        display: flex; /* 横並び */
        flex-direction: row; /* 横方向に並べる */
        overflow-x: auto; /* 横スクロール可能に */
      }
      .modalItem {
        border: 1px solid #ddd; /* 枠線 */
        margin-right: 10px; /* 右に余白 */
        padding: 5px; /* 内側に余白 */
        text-align: center; /* 文字は中央 */
      }
      .modalItem img {
        max-width: 100px; /* 画像の最大幅を100px */
        display: block; /* ブロック要素 */
        margin: 0 auto 5px; /* 中央配置して下に余白 */
      }
      #closeModal {
        width: 100%; /* ボタンは横いっぱい */
        margin-top: 15px; /* 上に余白 */
        background-color: #4caf50; /* 背景は緑 */
        color: #fff; /* 文字色は白 */
        border: none; /* 枠線なし */
        padding: 5px 10px; /* 内側に余白 */
        cursor: pointer; /* カーソルはポインター */
      }
    </style>
  </head>
  <body>
    <header>
      <div class="hamburger" id="hamburgerBtn">&#9776;</div>
      <!-- ハンバーガーアイコン -->
      <h1 style="margin: 0; font-size: 18px">アバター管理</h1>
    </header>

    <div id="modalWindow">
      <div id="modalContent">
        <!-- モーダルに詳細表示する内容 -->
      </div>
      <button id="closeModal">閉じる</button>
    </div>

    <button id="switchToLeft">←</button>
    <button id="switchToRight" style="display: none">→</button>

    <div class="main-container" id="mainContainer">
      <div class="sidebar" id="sidebar">
        <ul>
          <li data-target="avatarForm">所持アバター追加</li>
          <li data-target="settings">設定</li>
          <li data-target="tradeSearch">販売アバター検索</li>
        </ul>
      </div>
      <div class="left-panel" id="leftPanel">
        <div id="avatarForm">
          <h2>所持アバター追加</h2>
          <div class="form-group">
            <label for="partInput">パーツ（表示名）:</label>
            <input
              type="text"
              id="partInput"
              list="partsList"
              autocomplete="on"
              placeholder="例: トップス"
            />
            <datalist id="partsList">
              <option value="トップス"></option>
              <option value="ボトムス"></option>
              <option value="ワンピース"></option>
              <option value="ヘアスタイル"></option>
              <option value="フェイス"></option>
              <option value="背景"></option>
              <option value="アウター"></option>
              <option value="セット衣装1"></option>
              <option value="セット衣装2"></option>
              <option value="帽子"></option>
              <option value="めがね"></option>
              <option value="アクセ1"></option>
              <option value="アクセ2"></option>
              <option value="雑貨1"></option>
              <option value="雑貨2"></option>
              <option value="ペット1"></option>
              <option value="ペット2"></option>
              <option value="ペット3"></option>
              <option value="ペット4"></option>
              <option value="エフェクト"></option>
              <option value="その他1"></option>
              <option value="その他2"></option>
              <option value="その他3"></option>
              <option value="その他4"></option>
              <option value="モイトイ"></option>
            </datalist>
          </div>
          <div class="form-group">
            <label for="type1Input">種類①:</label>
            <input
              type="text"
              id="type1Input"
              list="type1List"
              autocomplete="on"
              placeholder="例: INT"
            />
            <datalist id="type1List">
              <option value="INT"></option>
              <option value="ALL"></option>
              <option value="HPR"></option>
              <option value="SP"></option>
              <option value="PET"></option>
              <option value="HP"></option>
              <option value="SPR"></option>
              <option value="LUK"></option>
              <option value="ATK"></option>
              <option value="EXP"></option>
              <option value="MAT"></option>
              <option value="POW"></option>
              <option value="VIT"></option>
              <option value="SPD"></option>
            </datalist>
          </div>
          <div class="form-group">
            <label for="type2Input">種類②:</label>
            <input
              type="text"
              id="type2Input"
              list="type2List"
              autocomplete="on"
              placeholder="（未入力でも可）"
              disabled
            />
            <datalist id="type2List">
              <option value="INT"></option>
              <option value="ALL"></option>
              <option value="HPR"></option>
              <option value="SP"></option>
              <option value="PET"></option>
              <option value="HP"></option>
              <option value="SPR"></option>
              <option value="LUK"></option>
              <option value="ATK"></option>
              <option value="EXP"></option>
              <option value="MAT"></option>
              <option value="POW"></option>
              <option value="VIT"></option>
              <option value="SPD"></option>
            </datalist>
          </div>
          <div class="form-group">
            <label for="valueInput">上昇値:</label>
            <input
              type="number"
              id="valueInput"
              placeholder="数値を入力してください"
            />
          </div>
          <button id="addButton" disabled>追加</button>
        </div>

        <div id="settings" style="display: none">
          <h2>設定</h2>
          <div class="form-group">
            <label for="genderSelect">アバター性別選択:</label>
            <select id="genderSelect">
              <option value="F">女</option>
              <option value="M">男</option>
            </select>
          </div>
          <div class="form-group">
            <label>更新希望ステータス:</label>
            <div id="updateStatusContainer" class="update-status-group"></div>
          </div>
          <button id="saveSettingsButton">設定を保存</button>
        </div>

        <div id="tradeSearch" style="display: none">
          <h2>販売アバター検索</h2>
          <div id="tradeDataDisplay">
            <p>データ未読み込み</p>
          </div>
        </div>
      </div>

      <div class="right-panel" id="rightPanel">
        <h2>追加されたアバター一覧</h2>
        <div class="scrollable-table-container">
          <table id="avatarTable">
            <thead>
              <tr>
                <th>販売リンク</th>
                <th>パーツ</th>
                <th>種類①</th>
                <th>種類②</th>
                <th>上昇値</th>
                <th>削除</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // グローバル変数：bagcatMapping にCSVの対応表を格納するよ
      let bagcatMapping = {};

      // CSV (bagcat_labels.csv) の読み込みとパース処理
      function loadBagcatLabels() {
        return fetch("bagcat_labels.csv")
          .then((response) => response.text())
          .then((text) => {
            const lines = text.split("\n");
            // 最初の1行はヘッダーなのでスキップするよ
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (line) {
                const parts = line.split(",");
                if (parts.length >= 2) {
                  const key = parts[0].trim(); // CSVの「parts」列の値
                  const value = parts[1].trim(); // CSVの「jp」列の値
                  bagcatMapping[key] = value;
                }
              }
            }
          })
          .catch((error) => {
            console.error("CSV読み込みエラー:", error);
          });
      }

      // --- 画面切替と初期設定 ---
      let currentView = "right";
      const mainContainer = document.getElementById("mainContainer");
      const leftPanel = document.getElementById("leftPanel");
      const rightPanel = document.getElementById("rightPanel");
      const switchToLeftBtn = document.getElementById("switchToLeft");
      const switchToRightBtn = document.getElementById("switchToRight");
      window.addEventListener("load", function () {
        currentView = "right";
        leftPanel.style.transform = "translateX(-100%)";
        rightPanel.style.transform = "translateX(0)";
        mainContainer.style.marginLeft = "0";
        switchToLeftBtn.style.display = "block";
        switchToRightBtn.style.display = "none";
        loadBagcatLabels(); // CSVの読み込みを実行
      });
      function switchToLeftView() {
        currentView = "left";
        leftPanel.style.transform = "translateX(0)";
        rightPanel.style.transform = "translateX(100%)";
        switchToLeftBtn.style.display = "none";
        switchToRightBtn.style.display = "block";
      }
      function switchToRightView() {
        currentView = "right";
        leftPanel.style.transform = "translateX(-100%)";
        rightPanel.style.transform = "translateX(0)";
        switchToLeftBtn.style.display = "block";
        switchToRightBtn.style.display = "none";
      }
      switchToLeftBtn.addEventListener("click", switchToLeftView);
      switchToRightBtn.addEventListener("click", switchToRightView);

      // --- サイドバーの処理 ---
      const hamburgerBtn = document.getElementById("hamburgerBtn");
      const sidebar = document.getElementById("sidebar");
      hamburgerBtn.addEventListener("click", function () {
        if (sidebar.style.left === "" || sidebar.style.left === "-220px") {
          sidebar.style.left = "0";
          mainContainer.style.marginLeft = "220px";
          switchToLeftBtn.style.left = "220px";
        } else {
          sidebar.style.left = "-220px";
          mainContainer.style.marginLeft = "0";
          switchToLeftBtn.style.left = "0";
        }
      });

      // --- サイドバー項目選択 ---
      const sidebarItems = document.querySelectorAll(".sidebar li");
      const avatarFormDiv = document.getElementById("avatarForm");
      const settingsDiv = document.getElementById("settings");
      const tradeSearchDiv = document.getElementById("tradeSearch");
      sidebarItems.forEach(function (item) {
        item.addEventListener("click", function () {
          const target = item.getAttribute("data-target");
          sidebar.style.left = "-220px";
          mainContainer.style.marginLeft = "0";
          switchToLeftBtn.style.left = "0";
          if (target === "avatarForm") {
            avatarFormDiv.style.display = "block";
            settingsDiv.style.display = "none";
            tradeSearchDiv.style.display = "none";
          } else if (target === "settings") {
            avatarFormDiv.style.display = "none";
            settingsDiv.style.display = "block";
            tradeSearchDiv.style.display = "none";
            const savedGender = localStorage.getItem("avatarGender");
            if (savedGender) {
              document.getElementById("genderSelect").value = savedGender;
            }
            generateUpdateStatusCheckboxes();
          } else if (target === "tradeSearch") {
            avatarFormDiv.style.display = "none";
            settingsDiv.style.display = "none";
            tradeSearchDiv.style.display = "block";
            logItemCodes();
          }
        });
      });

      // --- 所持アバター追加フォーム ---
      // partsMapping は固定の内部コードとの照合用
      const partsMapping = {
        トップス: "H",
        ボトムス: "L",
        ワンピース: "HL",
        ヘアスタイル: "P",
        フェイス: "F",
        背景: "A4",
        アウター: "CT",
        セット衣装1: "SA",
        セット衣装2: "SB",
        帽子: "AE",
        めがね: "AD",
        アクセ1: "AF",
        アクセ2: "B2",
        雑貨1: "B1",
        雑貨2: "B3",
        ペット1: "E1",
        ペット2: "E2",
        ペット3: "E3",
        ペット4: "E4",
        エフェクト: "AA",
        その他1: "AB",
        その他2: "A1",
        その他3: "A2",
        その他4: "A3",
        モイトイ: "BL",
      };
      // CSVから読み込んだbagcatMappingを使用するので、固定のbagcatLabels定義は削除

      const typeOptions = [
        "INT",
        "ALL",
        "HPR",
        "SP",
        "PET",
        "HP",
        "SPR",
        "LUK",
        "ATK",
        "EXP",
        "MAT",
        "POW",
        "VIT",
        "SPD",
      ];
      let avatarList = [];
      window.addEventListener("load", function () {
        const storedData = localStorage.getItem("avatarList");
        if (storedData) {
          avatarList = JSON.parse(storedData);
          renderAvatarTable();
        }
      });
      const partInput = document.getElementById("partInput");
      const type1Input = document.getElementById("type1Input");
      const type2Input = document.getElementById("type2Input");
      const valueInput = document.getElementById("valueInput");
      const addButton = document.getElementById("addButton");
      const avatarTableBody = document.querySelector("#avatarTable tbody");
      type1Input.addEventListener("change", function () {
        const selectedType1 = type1Input.value.trim();
        if (selectedType1 === "") {
          type2Input.disabled = true;
          type2Input.value = "";
        } else {
          type2Input.disabled = false;
          updateType2Datalist(selectedType1);
        }
        checkInput();
      });
      partInput.addEventListener("input", checkInput);
      type1Input.addEventListener("input", checkInput);
      valueInput.addEventListener("input", checkInput);
      function checkInput() {
        const isPartEntered = partInput.value.trim() !== "";
        const isType1Entered = type1Input.value.trim() !== "";
        const isValueEntered =
          valueInput.value.trim() !== "" && !isNaN(valueInput.value);
        addButton.disabled = !(
          isPartEntered &&
          isType1Entered &&
          isValueEntered
        );
      }
      function updateType2Datalist(selectedType1) {
        const type2Datalist = document.getElementById("type2List");
        type2Datalist.innerHTML = "";
        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        type2Datalist.appendChild(emptyOption);
        typeOptions.forEach(function (option) {
          if (option !== selectedType1) {
            const opt = document.createElement("option");
            opt.value = option;
            type2Datalist.appendChild(opt);
          }
        });
      }
      addButton.addEventListener("click", function () {
        const newAvatar = {
          partText: partInput.value.trim(),
          type1: type1Input.value.trim(),
          type2:
            type2Input.value.trim() === "" ? "なし" : type2Input.value.trim(),
          increase: valueInput.value.trim(),
        };
        avatarList.push(newAvatar);
        renderAvatarTable();
        localStorage.setItem("avatarList", JSON.stringify(avatarList));
        partInput.value = "";
        type1Input.value = "";
        type2Input.value = "";
        type2Input.disabled = true;
        valueInput.value = "";
        checkInput();
      });
      function renderAvatarTable() {
        avatarTableBody.innerHTML = "";
        avatarList.forEach(function (avatar, index) {
          const row = document.createElement("tr");
          const tdPart = document.createElement("td");
          tdPart.textContent = avatar.partText;
          row.appendChild(tdPart);
          const tdType1 = document.createElement("td");
          tdType1.textContent = avatar.type1;
          row.appendChild(tdType1);
          const tdType2 = document.createElement("td");
          tdType2.textContent = avatar.type2;
          row.appendChild(tdType2);
          const tdInc = document.createElement("td");
          tdInc.textContent = avatar.increase;
          row.appendChild(tdInc);
          const tdDel = document.createElement("td");
          const btnDel = document.createElement("button");
          btnDel.textContent = "削除";
          btnDel.addEventListener("click", function () {
            avatarList.splice(index, 1);
            renderAvatarTable();
            localStorage.setItem("avatarList", JSON.stringify(avatarList));
          });
          tdDel.appendChild(btnDel);
          row.appendChild(tdDel);
          avatarTableBody.appendChild(row);
        });
      }

      // --- 設定画面 ---
      const saveSettingsButton = document.getElementById("saveSettingsButton");
      const genderSelect = document.getElementById("genderSelect");
      const updateStatusContainer = document.getElementById(
        "updateStatusContainer"
      );
      const updateStatusOptions = typeOptions;
      function generateUpdateStatusCheckboxes() {
        updateStatusContainer.innerHTML = "";
        let savedStatus = localStorage.getItem("updateStatus");
        if (savedStatus) {
          savedStatus = JSON.parse(savedStatus);
        } else {
          savedStatus = [];
        }
        updateStatusOptions.forEach(function (status) {
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = "status_" + status;
          checkbox.value = status;
          if (savedStatus.includes(status)) {
            checkbox.checked = true;
          }
          const label = document.createElement("label");
          label.htmlFor = "status_" + status;
          label.textContent = status;
          updateStatusContainer.appendChild(checkbox);
          updateStatusContainer.appendChild(label);
        });
      }
      saveSettingsButton.addEventListener("click", function () {
        localStorage.setItem("avatarGender", genderSelect.value);
        const checkboxes = updateStatusContainer.querySelectorAll(
          'input[type="checkbox"]'
        );
        const selectedStatuses = [];
        checkboxes.forEach(function (chk) {
          if (chk.checked) {
            selectedStatuses.push(chk.value);
          }
        });
        localStorage.setItem("updateStatus", JSON.stringify(selectedStatuses));
        alert("設定を保存しました。");
      });

      // --- 販売アバター検索処理 ---
      let uniqueTradeItems = [];
      function logItemCodes() {
        Promise.all([
          loadBagcatLabels(),
          fetch("bazzarList.json").then((response) => response.json()),
          fetch("itemCodeSchema.json").then((response) => response.json()),
          fetch("itemAnother.json").then((response) => response.json()),
        ])
          .then(function ([, bazzarData, itemSchemaData, itemAnotherData]) {
            if (Array.isArray(itemSchemaData)) {
              itemSchemaData = itemSchemaData.map(function (entry) {
                // 正規表現で【から+までをtype、+から】までをparamとして抽出する
                // param部に「％」があれば取り除く
                var regex = /^【([^+]+)\+([^】]+)】/;
                var result = regex.exec(entry.itemName);
                if (result) {
                  entry.type = result[1];
                  let paramStr = result[2].replace(/％/g, "");
                  entry.param = parseInt(paramStr, 10);
                } else {
                  entry.type = "";
                  entry.param = 0;
                }
                // もしCSVに対応するpartsが存在しないならログを出力する
                if (!bagcatMapping[entry.parts]) {
                  console.log("Processed entry:", entry);
                }
                return entry;
              });
            }

            var combinedItems = [];
            if (Array.isArray(itemSchemaData)) {
              combinedItems = combinedItems.concat(itemSchemaData);
            }
            if (Array.isArray(itemAnotherData)) {
              combinedItems = combinedItems.concat(itemAnotherData);
            }

            var seenBazaarIds = {};
            uniqueTradeItems = [];
            bazzarData.bazzarList.forEach(function (item) {
              if (!seenBazaarIds[item.bazaarId]) {
                uniqueTradeItems.push(item);
                seenBazaarIds[item.bazaarId] = true;
              }
            });

            uniqueTradeItems.forEach(function (item) {
              if (Array.isArray(item.listingItems)) {
                item.listingItems = item.listingItems.map(function (itemCode) {
                  var match = combinedItems.find(function (entry) {
                    return entry.itemCode === itemCode;
                  });
                  if (match) {
                    return {
                      itemCode: itemCode,
                      itemName: match.itemName,
                      parts: match.parts,
                      itemGender: match.itemGender,
                      type: match.type,
                      param: match.param,
                    };
                  } else {
                    return {
                      itemCode: itemCode,
                      itemName: "",
                      parts: "",
                      itemGender: "",
                      type: "",
                      param: 0,
                    };
                  }
                });
              }
            });

            uniqueTradeItems.forEach(function (item) {
              if (Array.isArray(item.listingItems)) {
                item.listingItems.forEach(function (listItem) {
                  var matchingAvatar = avatarList.find(function (avatar) {
                    return (
                      avatar.type1 === listItem.type &&
                      partsMapping[avatar.partText] === listItem.parts
                    );
                  });
                  var diff = 0;
                  if (matchingAvatar) {
                    diff = listItem.param - Number(matchingAvatar.increase);
                    if (diff < 0) diff = 0;
                  } else {
                    diff = listItem.param;
                  }
                  listItem.diff = diff;
                });
              }
            });

            uniqueTradeItems.forEach(function (item) {
              if (
                Array.isArray(item.listingItems) &&
                item.listingItems.length > 0
              ) {
                var uniqueDiffs = {};
                item.listingItems.forEach(function (listItem) {
                  var key = listItem.type + "_" + listItem.parts;
                  if (uniqueDiffs[key] === undefined) {
                    uniqueDiffs[key] = listItem.diff;
                  } else {
                    if (listItem.diff > uniqueDiffs[key]) {
                      uniqueDiffs[key] = listItem.diff;
                    }
                  }
                });
                item.typeSums = {};
                for (var key in uniqueDiffs) {
                  if (uniqueDiffs.hasOwnProperty(key)) {
                    var t = key.split("_")[0];
                    if (!item.typeSums[t]) {
                      item.typeSums[t] = 0;
                    }
                    item.typeSums[t] += uniqueDiffs[key];
                  }
                }
              }
            });

            var selectedGender = localStorage.getItem("avatarGender");
            var filteredTradeItems = uniqueTradeItems.filter(function (item) {
              if (!item.listingItems || !Array.isArray(item.listingItems))
                return true;
              if (selectedGender === "F") {
                return !item.listingItems.some(function (listItem) {
                  return listItem.itemGender === "M";
                });
              } else if (selectedGender === "M") {
                return !item.listingItems.some(function (listItem) {
                  return listItem.itemGender === "F";
                });
              }
              return true;
            });

            var savedUpdateStatus = localStorage.getItem("updateStatus");
            var selectedTypes = [];
            if (savedUpdateStatus) {
              selectedTypes = JSON.parse(savedUpdateStatus);
            }
            var displayTypes = selectedTypes.slice().sort(function (a, b) {
              var idxA = typeOptions.indexOf(a);
              var idxB = typeOptions.indexOf(b);
              return idxA - idxB;
            });

            var tableHTML = "<div class='scrollable-table-container'>";
            tableHTML += "<table style='border-collapse: collapse;'>";
            tableHTML += "<thead><tr>";
            tableHTML +=
              "<th style='border: 1px solid #ccc; padding: 8px;'>販売リンク</th>";
            tableHTML +=
              "<th style='border: 1px solid #ccc; padding: 8px;'>締め切り日時</th>";
            tableHTML +=
              "<th style='border: 1px solid #ccc; padding: 8px;'>ハンコイン</th>";
            displayTypes.forEach(function (t) {
              tableHTML +=
                "<th style='border: 1px solid #ccc; padding: 8px;'>" +
                t +
                "<br>(ハンコイン/差分)</th>";
            });
            tableHTML +=
              "<th style='border: 1px solid #ccc; padding: 8px;'>詳細</th>";
            tableHTML += "</tr></thead>";
            tableHTML += "<tbody>";
            filteredTradeItems.forEach(function (item) {
              var sellEndDate = item.sellEndDate || "";
              if (sellEndDate.indexOf(" ") !== -1) {
                sellEndDate = sellEndDate.split(" ").join("<br>");
              }
              var hancoin = Number(item.hancoin) || 0;
              tableHTML += "<tr>";
              tableHTML +=
                "<td style='border: 1px solid #ccc; padding: 8px;'><button onclick='openLinkInNewTab(\"" +
                item.bazaarId +
                "\")'>販売リンク</button></td>";
              tableHTML +=
                "<td style='border: 1px solid #ccc; padding: 8px;'>" +
                sellEndDate +
                "</td>";
              tableHTML +=
                "<td style='border: 1px solid #ccc; padding: 8px;'>" +
                hancoin +
                "</td>";
              displayTypes.forEach(function (t) {
                var sumDiff =
                  item.typeSums && item.typeSums[t] ? item.typeSums[t] : 0;
                var ratio =
                  sumDiff !== 0 ? (hancoin / sumDiff).toFixed(2) : "0";
                tableHTML +=
                  "<td style='border: 1px solid #ccc; padding: 8px;'>" +
                  ratio +
                  "</td>";
              });
              tableHTML +=
                "<td style='border: 1px solid #ccc; padding: 8px;'><button onclick='showModal(\"" +
                item.bazaarId +
                "\")'>詳細</button></td>";
              tableHTML += "</tr>";
            });
            tableHTML += "</tbody></table>";
            tableHTML += "</div>";
            document.getElementById("tradeDataDisplay").innerHTML = tableHTML;

            var tradeTable = document.querySelector(
              "#tradeDataDisplay .scrollable-table-container table"
            );
            if (tradeTable) {
              var tradeHeaderCells = tradeTable.querySelectorAll("thead th");
              tradeHeaderCells.forEach(function (cell, index) {
                cell.addEventListener("click", function () {
                  sortTableByColumn(tradeTable, index);
                });
              });
            }
          })
          .catch(function (error) {
            console.error("【DEBUG】エラー発生:", error);
          });
      }

      function openLinkInNewTab(bazaarId) {
        const url =
          "https://puretomo.hange.jp/bazaar/exhibitDetail/?info=LISTING_DETAIL&bazaarId=" +
          bazaarId;
        window.open(url, "_blank");
      }

      // --- モーダルウィンドウ ---
      const modalWindow = document.getElementById("modalWindow");
      const modalContent = document.getElementById("modalContent");
      const closeModalBtn = document.getElementById("closeModal");
      closeModalBtn.addEventListener("click", function () {
        modalWindow.style.display = "none";
        modalContent.innerHTML = "";
      });
      function showModal(bazaarId) {
        var item = uniqueTradeItems.find(function (itm) {
          return itm.bazaarId === bazaarId;
        });
        if (!item) return;
        modalContent.innerHTML = "";
        if (Array.isArray(item.listingItems)) {
          item.listingItems.forEach(function (listItem) {
            var itemDiv = document.createElement("div");
            itemDiv.className = "modalItem";
            var img = document.createElement("img");
            img.src =
              "https://puretomo-image.hange.jp/disp/" +
              listItem.itemCode.toLowerCase() +
              ".gif";
            itemDiv.appendChild(img);
            // CSVから読み込んだ bagcatMapping を参照して日本語に変換する
            var partsText = bagcatMapping[listItem.parts];
            if (!partsText) {
              console.error(
                "Mapping not found for parts code:",
                listItem.parts
              );
              partsText = listItem.parts;
            }
            var diffText = listItem.type + "+" + listItem.diff;
            var infoP = document.createElement("p");
            infoP.textContent = partsText + " / 差分: " + diffText;
            itemDiv.appendChild(infoP);
            var nameP = document.createElement("p");
            nameP.textContent = listItem.itemName;
            itemDiv.appendChild(nameP);
            modalContent.appendChild(itemDiv);
          });
        }
        modalWindow.style.display = "block";
      }

      function sortTableByColumn(table, colIndex) {
        var tbody = table.querySelector("tbody");
        var rows = Array.from(tbody.querySelectorAll("tr"));
        rows.sort(function (rowA, rowB) {
          var cellA = rowA.children[colIndex];
          var cellB = rowB.children[colIndex];
          var numA = parseFloat(cellA.textContent);
          var numB = parseFloat(cellB.textContent);
          var sortA = isNaN(numA) || numA === 0 ? Infinity : numA;
          var sortB = isNaN(numB) || numB === 0 ? Infinity : numB;
          return sortA - sortB;
        });
        rows.forEach(function (row) {
          tbody.appendChild(row);
        });
      }

      var avatarTable = document.getElementById("avatarTable");
      if (avatarTable) {
        var avatarHeaderCells = avatarTable.querySelectorAll("thead th");
        avatarHeaderCells.forEach(function (cell, index) {
          cell.addEventListener("click", function () {
            sortTableByColumn(avatarTable, index);
          });
        });
      }
    </script>
  </body>
</html>
